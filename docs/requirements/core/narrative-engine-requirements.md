---
title: Narrative Engine Requirements
aliases: [Storytelling System Requirements]
tags: [narraitor, requirements, narrative-engine]
created: 2025-04-29
updated: 2025-04-29
---

# Narrative Engine Requirements

## Overview
The Narrative Engine is the core storytelling system in Narraitor, responsible for generating contextually appropriate narrative content, presenting choices to the player, and evolving the story based on player decisions. It integrates with AI services to create dynamic, responsive narratives that adapt to the world configuration and player character.

## Core Functionality
- **Narrative Generation**: Create world-appropriate narrative content using AI
- **Decision Points**: Present meaningful choices to the player
- **Context Management**: Maintain and update narrative context
- **History Tracking**: Record narrative events and player choices
- **Decision Impact**: Track the impact of player decisions on the narrative
- **Scene Management**: Create and transition between narrative scenes
- **Prompt Construction**: Build effective prompts for the AI service
- **Context Optimization**: Optimize context to maintain token efficiency
- **Error Handling**: Gracefully handle AI service failures
- **Narrative Formatting**: Apply appropriate formatting to narrative text
- **Fallback Content**: Provide pre-written content when AI fails

## Data Model

```typescript
interface NarrativeState {
  id: string;
  worldId: string;
  characterId: string;
  currentStoryPoint: StoryPoint | null;
  visitedPoints: string[];
  availableChoices: NarrativeChoice[];
  narrativeHistory: NarrativeHistoryEntry[];
  narrativeContext: NarrativeContext;
  selectedChoice?: string;
  currentDecision?: PlayerDecision;
  error?: NarrativeErrorInfo | null;
  currentLocation?: string;
  narrativeMode?: 'normal' | 'dialogue';
  lastRequestTimestamp?: number;
  failedAttempts?: number;
  createdAt: string;
  updatedAt: string;
}

interface StoryPoint {
  id: string;
  content: string;
  type: 'scene' | 'encounter' | 'dialogue';
  timestamp: number;
  formattedContent?: string;
  location?: string;
}

interface NarrativeChoice {
  id: string;
  text: string;
  tags: string[];
  relatedAttributes?: string[];
  relatedSkills?: string[];
}

interface PlayerDecision {
  id: string;
  prompt: string;
  options: {
    id: string;
    text: string;
    tags: string[];
  }[];
  selectedOptionId?: string;
  timestamp: number;
  location?: string;
}

interface NarrativeHistoryEntry {
  id: string;
  content: string;
  type: 'narrative' | 'decision' | 'outcome' | 'system';
  timestamp: number;
  formattedContent?: string;
  location?: string;
}

interface NarrativeContext {
  worldId: string;
  characterId: string;
  location: string;
  recentEvents: string[];
  importantDecisions: PlayerDecision[];
  toneSettings: any; // From World Configuration
  contextSize?: number;
}

interface NarrativeErrorInfo {
  code: string;
  message: string;
  recoverable: boolean;
  timestamp: number;
  attemptCount: number;
  lastSuccessfulResponse?: string;
}
```

## User Interactions
- Users read narrative content generated by the AI
- Users select from available choices to direct the narrative
- Users see the impact of their decisions reflected in subsequent narrative
- Users review narrative history through the journal system
- Users navigate between different locations or scenes through choices
- Users view properly formatted narrative text with paragraphs and dialogue

## Integration Points
- **World System**: Uses world configuration to inform narrative style and content
- **Character System**: Uses character information to personalize the narrative
- **Journal System**: Records narrative events and decisions for journal entries
- **State Management**: Persists narrative state between sessions
- **AI Service**: Generates narrative content through API integration
- **Decision Tracking**: Records and references player choices

## MVP Scope Boundaries

### Included
- Narrative generation using Google Gemini API with the following capabilities:
  - Generation of world and character-appropriate content
  - Respect for tone settings (narrative style, content rating)
  - Scene-based storytelling with clear transitions
  - Basic recognition of player character attributes and skills
- Player choice system with:
  - 3-4 distinct choices per decision point
  - Clear presentation of options
  - Basic impact tracking of decisions
  - Appropriate continuation based on selection
- Context management with:
  - Last 5-10 narrative segments retained
  - Important character information
  - Recent decisions and outcomes
  - Current location/setting
- History tracking that records:
  - All narrative segments
  - Player decisions and selections
  - Major outcome changes
- Scene transitions that:
  - Clearly indicate location/setting changes
  - Maintain narrative coherence
- Basic error recovery with:
  - Retry capability for failed AI calls
  - Fallback content for unrecoverable errors
  - User-friendly error messages
- Prompt construction system that:
  - Creates effective prompts for the AI service
  - Includes relevant context from world and character
  - Maintains consistent tone and style
  - Optimizes token usage for efficiency
- Basic formatting for narrative text:
  - Paragraph breaks
  - Dialogue formatting
  - Emphasis for important elements
- DevTools integration to expose helpful info/debug tools

### Excluded from MVP
- Complex branching narrative structures
- Advanced character relationship tracking
- Long-term narrative planning
- Multiple concurrent storylines
- Procedural quest generation
- Advanced dialogue system with NPC memory
- NPC interaction systems beyond basic dialogue choices
- Narrative visualization (maps, diagrams, etc.)
- Voice narration or audio effects
- Advanced emotion or sentiment analysis
- Multi-thread storytelling
- Direct modification of generated content
- Custom story templates
- Dynamic difficulty adjustment
- Narrative-based puzzles or challenges
- Environmental interactions beyond basic choices
- Complex NPC tracking with individual traits and dispositions
- Advanced location management with connections and descriptions
- Narrative image generation
- Importance ranking for narrative events
- Multiple narrative modes beyond normal and basic dialogue

## User Stories
For detailed user stories, please see the [Narrative Engine User Stories CSV file](./narrative-engine-user-stories.csv).

## BootHillGM Reference Code
- The narrative context implementation in `src/app/context/NarrativeContext.tsx` and related hooks provide a proven structure for narrative state management
- The optimization in `src/app/components/GamePromptWithOptimizedContext.tsx` demonstrates effective token usage management
- The AI service in `src/app/services/ai/aiService.ts` shows patterns for reliable AI integration with fallbacks
- The response parsing in `src/app/services/ai/responseParser.ts` offers techniques for handling AI outputs
- The prompt construction in `src/app/services/ai/promptBuilder.ts` provides templates for effective AI prompting
- The narrative formatting in `src/app/components/NarrativeDisplay.tsx` shows how to properly display formatted text
- The error handling in `src/app/components/GameSessionContent.tsx` demonstrates recovery from AI service failures
- The fallback generation in `src/app/services/ai/fallback/fallbackDecisionGenerator.ts` provides patterns for creating backup content

## Status
- [x] Requirements defined
- [ ] GitHub issues created
- [ ] Implementation started
- [ ] Implementation completed
- [ ] Acceptance criteria met