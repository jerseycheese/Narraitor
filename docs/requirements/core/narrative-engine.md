---
title: Narrative Engine Requirements
aliases: [Storytelling System Requirements]
tags: [narraitor, requirements, narrative-engine]
created: 2025-04-29
updated: 2025-04-29
---

# Narrative Engine Requirements

## Overview
The Narrative Engine is the core storytelling system in Narraitor, responsible for generating contextually appropriate narrative content, presenting choices to the player, and evolving the story based on player decisions. It integrates with AI services to create dynamic, responsive narratives that adapt to the world configuration and player character.

## Core Functionality
- **Narrative Generation**: Create world-appropriate narrative content using AI
- **Decision Points**: Present meaningful choices to the player
- **Context Management**: Maintain and update narrative context
- **History Tracking**: Record narrative events and player choices
- **Decision Impact**: Track the impact of player decisions on the narrative
- **Scene Management**: Create and transition between narrative scenes
- **Prompt Construction**: Build effective prompts for the AI service
- **Context Optimization**: Optimize context to maintain token efficiency
- **Error Handling**: Gracefully handle AI service failures
- **Narrative Formatting**: Apply appropriate formatting to narrative text
- **Fallback Content**: Provide pre-written content when AI fails

## Data Model

```typescript
interface NarrativeState {
  id: string;
  worldId: string;
  characterId: string;
  currentStoryPoint: StoryPoint | null;
  visitedPoints: string[];
  availableChoices: NarrativeChoice[];
  narrativeHistory: NarrativeHistoryEntry[];
  narrativeContext: NarrativeContext;
  selectedChoice?: string;
  currentDecision?: PlayerDecision;
  error?: NarrativeErrorInfo | null;
  currentLocation?: string;
  narrativeMode?: 'normal' | 'dialogue';
  lastRequestTimestamp?: number;
  failedAttempts?: number;
  createdAt: string;
  updatedAt: string;
}

interface StoryPoint {
  id: string;
  content: string;
  type: 'scene' | 'encounter' | 'dialogue';
  timestamp: number;
  formattedContent?: string;
  location?: string;
}

interface NarrativeChoice {
  id: string;
  text: string;
  tags: string[];
  relatedAttributes?: string[];
  relatedSkills?: string[];
}

interface PlayerDecision {
  id: string;
  prompt: string;
  options: {
    id: string;
    text: string;
    tags: string[];
  }[];
  selectedOptionId?: string;
  timestamp: number;
  location?: string;
}

interface NarrativeHistoryEntry {
  id: string;
  content: string;
  type: 'narrative' | 'decision' | 'outcome' | 'system';
  timestamp: number;
  formattedContent?: string;
  location?: string;
}

interface NarrativeContext {
  worldId: string;
  characterId: string;
  location: string;
  recentEvents: string[];
  importantDecisions: PlayerDecision[];
  toneSettings: any; // From World Configuration
  contextSize?: number;
}

interface NarrativeErrorInfo {
  code: string;
  message: string;
  recoverable: boolean;
  timestamp: number;
  attemptCount: number;
  lastSuccessfulResponse?: string;
}
```

## User Interactions
- Users read narrative content generated by the AI
- Users select from available choices to direct the narrative
- Users see the impact of their decisions reflected in subsequent narrative
- Users review narrative history through the journal system
- Users navigate between different locations or scenes through choices
- Users view properly formatted narrative text with paragraphs and dialogue

## Integration Points
- **World System**: Uses world configuration to inform narrative style and content
- **Character System**: Uses character information to personalize the narrative
- **Journal System**: Records narrative events and decisions for journal entries
- **State Management**: Persists narrative state between sessions
- **AI Service**: Generates narrative content through API integration
- **Decision Tracking**: Records and references player choices

## MVP Scope Boundaries

### Included
- Narrative generation using Google Gemini API with the following capabilities:
  - Generation of world and character-appropriate content
  - Respect for tone settings (narrative style, content rating)
  - Scene-based storytelling with clear transitions
  - Basic recognition of player character attributes and skills
- Player choice system with:
  - 3-4 distinct choices per decision point
  - Clear presentation of options
  - Basic impact tracking of decisions
  - Appropriate continuation based on selection
- Context management with:
  - Last 5-10 narrative segments retained
  - Important character information
  - Recent decisions and outcomes
  - Current location/setting
- History tracking that records:
  - All narrative segments
  - Player decisions and selections
  - Major outcome changes
- Scene transitions that:
  - Clearly indicate location/setting changes
  - Maintain narrative coherence
- Basic error recovery with:
  - Retry capability for failed AI calls
  - Fallback content for unrecoverable errors
  - User-friendly error messages
- Prompt construction system that:
  - Creates effective prompts for the AI service
  - Includes relevant context from world and character
  - Maintains consistent tone and style
  - Optimizes token usage for efficiency
- Basic formatting for narrative text:
  - Paragraph breaks
  - Dialogue formatting
  - Emphasis for important elements
- DevTools integration to expose helpful info/debug tools

### Excluded from MVP
- Complex branching narrative structures
- Advanced character relationship tracking
- Long-term narrative planning
- Multiple concurrent storylines
- Procedural quest generation
- Advanced dialogue system with NPC memory
- NPC interaction systems beyond basic dialogue choices
- Narrative visualization (maps, diagrams, etc.)
- Voice narration or audio effects
- Advanced emotion or sentiment analysis
- Multi-thread storytelling
- Direct modification of generated content
- Custom story templates
- Dynamic difficulty adjustment
- Narrative-based puzzles or challenges
- Environmental interactions beyond basic choices
- Complex NPC tracking with individual traits and dispositions
- Advanced location management with connections and descriptions
- Narrative image generation
- Importance ranking for narrative events
- Multiple narrative modes beyond normal and basic dialogue

## User Stories

1. **Narrative Generation**
- As a user, I want to read engaging narrative content that matches my selected world so I can immerse myself in the story (Complexity: Large, Priority: High)
- As a user, I want the narrative to acknowledge my character's attributes and skills so the story feels personalized (Complexity: Large, Priority: High)
- As a user, I want content that respects my chosen tone settings so the narrative style meets my expectations (Complexity: Medium, Priority: High)
- As a user, I want properly formatted text with paragraphs and dialogue so it's easy to read (Complexity: Medium, Priority: High)

2. **Player Choices**
- As a user, I want to make meaningful decisions that affect the narrative so I feel agency in the story (Complexity: Large, Priority: High)
- As a user, I want clear choices that represent different approaches so I can express my character's personality (Complexity: Medium, Priority: High)
- As a user, I want to see the consequences of my decisions reflected in the narrative so my choices matter (Complexity: Large, Priority: High)

3. **Narrative Flow**
- As a user, I want smooth transitions between scenes so the story maintains coherence (Complexity: Medium, Priority: Medium)
- As a user, I want the narrative to remember important decisions I've made so the story remains consistent (Complexity: Large, Priority: High)

4. **Error Handling**
- As a user, I want graceful error handling when AI requests fail so my experience isn't disrupted (Complexity: Medium, Priority: High)
- As a user, I want fallback content when the AI service is unavailable so I can continue playing (Complexity: Medium, Priority: Medium)
- As a user, I want clear error messages that don't break immersion so my narrative experience is preserved (Complexity: Small, Priority: Medium)

5. **Development Support**
- As a developer, I want to debug and inspect narrative state during development (Complexity: Large, Priority: Medium)
- As a developer, I want to see how prompts are constructed and optimized (Complexity: Large, Priority: Medium)

## Acceptance Criteria
1. The system generates coherent narrative content appropriate to the selected world
2. Narrative content respects the character attributes and skills
3. Player choices influence subsequent narrative development in meaningful ways
4. The narrative respects world tone settings (family-friendly vs mature, etc.)
5. The system maintains sufficient context to create a cohesive story
6. Narrative history is recorded and accessible through the journal system
7. The system recovers gracefully from AI service failures
8. Scene transitions maintain narrative continuity
9. The system optimizes prompts to stay within token limits
10. Generated content is free from inappropriate material based on content rating
11. Narrative text is properly formatted with paragraphs and dialogue formatting
12. Choice options reflect the current narrative context appropriately
13. The system provides fallback content when AI generation fails
14. DevTools provide visibility into narrative state and AI interactions

## GitHub Issues
- [Implement narrative state management] - Link to GitHub issue
- [Create AI prompt construction system] - Link to GitHub issue
- [Build player choice interface] - Link to GitHub issue
- [Develop narrative history tracking] - Link to GitHub issue
- [Implement context management system] - Link to GitHub issue
- [Create scene transition logic] - Link to GitHub issue
- [Build narrative text display component] - Link to GitHub issue
- [Implement error handling and recovery] - Link to GitHub issue
- [Create token optimization system] - Link to GitHub issue
- [Implement text formatting for narrative content] - Link to GitHub issue
- [Create fallback content system] - Link to GitHub issue
- [Implement DevTools integration for narrative engine] - Link to GitHub issue

## BootHillGM Reference Code
- The narrative context implementation in `/app/context/NarrativeContext.tsx` and related hooks provide a proven structure for narrative state management
- The optimization in `/app/components/GamePromptWithOptimizedContext.tsx` demonstrates effective token usage management
- The AI service in `/app/services/ai/aiService.ts` shows patterns for reliable AI integration with fallbacks
- The response parsing in `/app/services/ai/responseParser.ts` offers techniques for handling AI outputs
- The prompt construction in `/app/services/ai/promptBuilder.ts` provides templates for effective AI prompting
- The narrative formatting in `/app/components/NarrativeDisplay.tsx` shows how to properly display formatted text
- The error handling in `/app/components/GameSessionContent.tsx` demonstrates recovery from AI service failures
- The fallback generation in `/app/services/ai/fallback/fallbackDecisionGenerator.ts` provides patterns for creating backup content

## Status
- [x] Requirements defined
- [ ] GitHub issues created
- [ ] Implementation started
- [ ] Implementation completed
- [ ] Acceptance criteria met
