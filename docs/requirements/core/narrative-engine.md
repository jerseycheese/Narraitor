---
title: Narrative Engine Requirements
aliases: [Storytelling System Requirements]
tags: [narraitor, requirements, narrative-engine]
created: 2025-04-29
updated: 2025-04-29
---

# Narrative Engine Requirements

## Overview
The Narrative Engine is the core storytelling system in Narraitor, responsible for generating contextually appropriate narrative content, presenting choices to the player, and evolving the story based on player decisions. It integrates with AI services to create dynamic, responsive narratives that adapt to the world configuration and player character.

## Core Functionality
- **Narrative Generation**: Create world-appropriate narrative content using AI
- **Decision Points**: Present meaningful choices to the player
- **Context Management**: Maintain and update narrative context
- **History Tracking**: Record narrative events and player choices
- **Decision Impact**: Track the impact of player decisions on the narrative
- **Scene Management**: Create and transition between narrative scenes
- **Prompt Construction**: Build effective prompts for the AI service
- **Context Optimization**: Optimize context to maintain token efficiency
- **Error Handling**: Gracefully handle AI service failures
- **Narrative Formatting**: Apply appropriate formatting to narrative text
- **Fallback Content**: Provide pre-written content when AI fails

## Data Model

```typescript
interface NarrativeState {
  id: string;
  worldId: string;
  characterId: string;
  currentStoryPoint: StoryPoint | null;
  visitedPoints: string[];
  availableChoices: NarrativeChoice[];
  narrativeHistory: NarrativeHistoryEntry[];
  narrativeContext: NarrativeContext;
  selectedChoice?: string;
  currentDecision?: PlayerDecision;
  error?: NarrativeErrorInfo | null;
  currentLocation?: string;
  narrativeMode?: 'normal' | 'dialogue';
  lastRequestTimestamp?: number;
  failedAttempts?: number;
  createdAt: string;
  updatedAt: string;
}

interface StoryPoint {
  id: string;
  content: string;
  type: 'scene' | 'encounter' | 'dialogue';
  timestamp: number;
  formattedContent?: string;
  location?: string;
}

interface NarrativeChoice {
  id: string;
  text: string;
  tags: string[];
  relatedAttributes?: string[];
  relatedSkills?: string[];
}

interface PlayerDecision {
  id: string;
  prompt: string;
  options: {
    id: string;
    text: string;
    tags: string[];
  }[];
  selectedOptionId?: string;
  timestamp: number;
  location?: string;
}

interface NarrativeHistoryEntry {
  id: string;
  content: string;
  type: 'narrative' | 'decision' | 'outcome' | 'system';
  timestamp: number;
  formattedContent?: string;
  location?: string;
}

interface NarrativeContext {
  worldId: string;
  characterId: string;
  location: string;
  recentEvents: string[];
  importantDecisions: PlayerDecision[];
  toneSettings: any; // From World Configuration
  contextSize?: number;
}

interface NarrativeErrorInfo {
  code: string;
  message: string;
  recoverable: boolean;
  timestamp: number;
  attemptCount: number;
  lastSuccessfulResponse?: string;
}
```

## User Interactions
- Users read narrative content generated by the AI
- Users select from available choices to direct the narrative
- Users see the impact of their decisions reflected in subsequent narrative
- Users review narrative history through the journal system
- Users navigate between different locations or scenes through choices
- Users view properly formatted narrative text with paragraphs and dialogue

## Integration Points
- **World System**: Uses world configuration to inform narrative style and content
- **Character System**: Uses character information to personalize the narrative
- **Journal System**: Records narrative events and decisions for journal entries
- **State Management**: Persists narrative state between sessions
- **AI Service**: Generates narrative content through API integration
- **Decision Tracking**: Records and references player choices

## MVP Scope Boundaries

### Included
- Narrative generation using Google Gemini API with the following capabilities:
  - Generation of world and character-appropriate content
  - Respect for tone settings (narrative style, content rating)
  - Scene-based storytelling with clear transitions
  - Basic recognition of player character attributes and skills
- Player choice system with:
  - 3-4 distinct choices per decision point
  - Clear presentation of options
  - Basic impact tracking of decisions
  - Appropriate continuation based on selection
- Context management with:
  - Last 5-10 narrative segments retained
  - Important character information
  - Recent decisions and outcomes
  - Current location/setting
- History tracking that records:
  - All narrative segments
  - Player decisions and selections
  - Major outcome changes
- Scene transitions that:
  - Clearly indicate location/setting changes
  - Maintain narrative coherence
- Basic error recovery with:
  - Retry capability for failed AI calls
  - Fallback content for unrecoverable errors
  - User-friendly error messages
- Prompt construction system that:
  - Creates effective prompts for the AI service
  - Includes relevant context from world and character
  - Maintains consistent tone and style
  - Optimizes token usage for efficiency
- Basic formatting for narrative text:
  - Paragraph breaks
  - Dialogue formatting
  - Emphasis for important elements
- DevTools integration to expose helpful info/debug tools

### Excluded from MVP
- Complex branching narrative structures
- Advanced character relationship tracking
- Long-term narrative planning
- Multiple concurrent storylines
- Procedural quest generation
- Advanced dialogue system with NPC memory
- NPC interaction systems beyond basic dialogue choices
- Narrative visualization (maps, diagrams, etc.)
- Voice narration or audio effects
- Advanced emotion or sentiment analysis
- Multi-thread storytelling
- Direct modification of generated content
- Custom story templates
- Dynamic difficulty adjustment
- Narrative-based puzzles or challenges
- Environmental interactions beyond basic choices
- Complex NPC tracking with individual traits and dispositions
- Advanced location management with connections and descriptions
- Narrative image generation
- Importance ranking for narrative events
- Multiple narrative modes beyond normal and basic dialogue

## User Stories

1. **Narrative Generation**
- As a user, I want to read engaging narrative content that matches my selected world so I can immerse myself in the story

  ## Priority
  - [x] High (MVP)
  - [ ] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [ ] Small
  - [ ] Medium
  - [x] Large

  **Acceptance Criteria**:
  1. The AI Service generates narrative text that aligns with the selected world's genre, description, and basic tone (as inferred from world description).
  2. The system handles basic scene transitions smoothly, maintaining narrative context.

- As a user, I want the narrative to acknowledge my character's attributes and skills so the story feels personalized

  ## Priority
  - [x] High (MVP)
  - [ ] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [ ] Small
  - [ ] Medium
  - [x] Large

  **Acceptance Criteria**:
  1. Generated narrative incorporates the active character's name, basic attributes, and selected skills when relevant to the scene.

- As a user, I want content that respects my chosen tone settings so the narrative style meets my expectations

  ## Priority
  - [x] High (MVP)
  - [ ] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [ ] Small
  - [x] Medium
  - [ ] Large

  **Acceptance Criteria**:
  1. The AI Service respects tone settings such as narrative style and content rating specified in the world configuration.
  2. Generated content maintains a consistent tone throughout the narrative session.

- As a user, I want properly formatted text with paragraphs and dialogue so it's easy to read

  ## Priority
  - [x] High (MVP)
  - [ ] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [ ] Small
  - [x] Medium
  - [ ] Large

  **Acceptance Criteria**:
  1. Narrative text is formatted with standard paragraph breaks.
  2. Dialogue is clearly distinguishable (e.g., using quotation marks).

2. **Player Choices**
- As a user, I want to make meaningful decisions that affect the narrative so I feel agency in the story

  ## Priority
  - [x] High (MVP)
  - [ ] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [ ] Small
  - [ ] Medium
  - [x] Large

  **Acceptance Criteria**:
  1. The system presents 3-4 distinct, contextually relevant choices to the player at appropriate narrative junctures.
  2. Player selections are recorded by the Player Decision System.

- As a user, I want clear choices that represent different approaches so I can express my character's personality

  ## Priority
  - [x] High (MVP)
  - [ ] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [ ] Small
  - [x] Medium
  - [ ] Large

  **Acceptance Criteria**:
  1. Choice options are presented clearly (e.g., as buttons or list items).
  2. Choices reflect different approaches or strategies appropriate to the narrative context.

- As a user, I want to see the consequences of my decisions reflected in the narrative so my choices matter

  ## Priority
  - [x] High (MVP)
  - [ ] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [ ] Small
  - [ ] Medium
  - [x] Large

  **Acceptance Criteria**:
  1. Subsequent narrative generation takes the player's most recent choice into account, reflecting its immediate consequence.
  2. Major decisions have visible impact on the progression of the story.

3. **Narrative Flow**
- As a user, I want smooth transitions between scenes so the story maintains coherence

  ## Priority
  - [ ] High (MVP)
  - [x] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [ ] Small
  - [x] Medium
  - [ ] Large

  **Acceptance Criteria**:
  1. Scene transitions (such as location changes) maintain narrative continuity by referring to the previous scene or reason for moving.
  2. The narrative context correctly tracks the current location/setting and uses it to inform scene descriptions.

- As a user, I want the narrative to remember important decisions I've made so the story remains consistent

  ## Priority
  - [x] High (MVP)
  - [ ] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [ ] Small
  - [ ] Medium
  - [x] Large

  **Acceptance Criteria**:
  1. The narrative context maintains a record of at least 3 important player decisions from previous interactions.
  2. These important decisions are referenced in subsequent narrative generation when contextually appropriate.

4. **Error Handling**
- As a user, I want graceful error handling when AI requests fail so my experience isn't disrupted

  ## Priority
  - [x] High (MVP)
  - [ ] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [ ] Small
  - [x] Medium
  - [ ] Large

  **Acceptance Criteria**:
  1. If the AI Service fails to generate content after retries, a user-friendly error message is displayed within the narrative flow.
  2. Errors are logged internally for debugging but do not expose technical details to the user unless in debug mode.

- As a user, I want fallback content when the AI service is unavailable so I can continue playing

  ## Priority
  - [ ] High (MVP)
  - [x] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [ ] Small
  - [x] Medium
  - [ ] Large

  **Acceptance Criteria**:
  1. A generic fallback narrative snippet or choice prompt is presented to allow the user to continue or retry.
  2. The system can operate with limited functionality when the AI service is unavailable.

- As a user, I want clear error messages that don't break immersion so my narrative experience is preserved

  ## Priority
  - [ ] High (MVP)
  - [x] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [x] Small
  - [ ] Medium
  - [ ] Large

  **Acceptance Criteria**:
  1. Error messages are phrased in a way that fits the narrative context when possible.
  2. Technical details are abstracted into user-friendly language appropriate to the game world.

5. **Development Support**
- As a developer, I want to debug and inspect narrative state during development

  ## Priority
  - [ ] High (MVP)
  - [x] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [ ] Small
  - [x] Medium
  - [ ] Large

  **Acceptance Criteria**:
  1. DevTools allow inspection of the current narrative state (e.g., recent history, current context).
  2. The system provides debug information about the narrative flow and decision tracking.

- As a developer, I want to see how prompts are constructed and optimized

  ## Priority
  - [ ] High (MVP)
  - [x] Medium (MVP Enhancement)
  - [ ] Low (Nice to Have)
  - [ ] Post-MVP

  ## Estimated Complexity
  - [ ] Small
  - [x] Medium
  - [ ] Large

  **Acceptance Criteria**:
  1. DevTools display the prompt sent to the AI Service and the raw response received for the last narrative turn.
  2. The system provides information about token usage and context optimization strategies.

## GitHub Issues
- [Implement narrative state management] - Link to GitHub issue
- [Create AI prompt construction system] - Link to GitHub issue
- [Build player choice interface] - Link to GitHub issue
- [Develop narrative history tracking] - Link to GitHub issue
- [Implement context management system] - Link to GitHub issue
- [Create scene transition logic] - Link to GitHub issue
- [Build narrative text display component] - Link to GitHub issue
- [Implement error handling and recovery] - Link to GitHub issue
- [Create token optimization system] - Link to GitHub issue
- [Implement text formatting for narrative content] - Link to GitHub issue
- [Create fallback content system] - Link to GitHub issue
- [Implement DevTools integration for narrative engine] - Link to GitHub issue

## BootHillGM Reference Code
- The narrative context implementation in `/app/context/NarrativeContext.tsx` and related hooks provide a proven structure for narrative state management
- The optimization in `/app/components/GamePromptWithOptimizedContext.tsx` demonstrates effective token usage management
- The AI service in `/app/services/ai/aiService.ts` shows patterns for reliable AI integration with fallbacks
- The response parsing in `/app/services/ai/responseParser.ts` offers techniques for handling AI outputs
- The prompt construction in `/app/services/ai/promptBuilder.ts` provides templates for effective AI prompting
- The narrative formatting in `/app/components/NarrativeDisplay.tsx` shows how to properly display formatted text
- The error handling in `/app/components/GameSessionContent.tsx` demonstrates recovery from AI service failures
- The fallback generation in `/app/services/ai/fallback/fallbackDecisionGenerator.ts` provides patterns for creating backup content

## Status
- [x] Requirements defined
- [ ] GitHub issues created
- [ ] Implementation started
- [ ] Implementation completed
- [ ] Acceptance criteria met
